{% extends "base.html" %}

{% block header_title %}ðŸ¤– ConsultorÃ­a IA (Ciplas AI-Master Cord){% endblock %}

{% block content %}
<div class="card glass" style="height: 60vh; display: flex; flex-direction: column;">
    <div id="chat-box" style="flex-grow: 1; overflow-y: auto; padding: 1rem;">
        <div class="message assistant"
            style="background: rgba(56, 189, 248, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; align-self: flex-start; max-width: 80%;">
            Â¿CÃ³mo optimizamos hoy? Estoy listo para analizar tu backlog y planta.
        </div>
    </div>

    <div style="padding: 1.5rem; border-top: 1px solid var(--border-color);">
        <div style="display: flex; gap: 1rem;">
            <input type="text" id="user-input" placeholder="Pregunta algo sobre la producciÃ³n..." class="form-control"
                style="flex-grow: 1;">
            <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
        </div>
    </div>
</div>

<div style="margin-top: 1.5rem;">
    <button class="btn glass" onclick="generateScenario()"
        style="border: 1px solid var(--accent-blue); color: var(--accent-blue); width: 100%;">
        Generar Escenario Ã“ptimo (Auto)
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const box = document.getElementById('chat-box');
        if (!input.value) return;

        const userMsg = input.value;
        box.innerHTML += `<div class="message user" style="background: rgba(99, 102, 241, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; align-self: flex-end; max-width: 80%; margin-left: auto;">${userMsg}</div>`;
        input.value = '';
        box.scrollTop = box.scrollHeight;

        try {
            const response = await fetch('/api/ai_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMsg })
            });
            const data = await response.json();

            box.innerHTML += `<div class="message assistant" style="background: rgba(56, 189, 248, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; align-self: flex-start; max-width: 80%;">${data.response || data.error}</div>`;
            box.scrollTop = box.scrollHeight;
        } catch (err) {
            console.error(err);
        }
    }

    async function generateScenario() {
        const box = document.getElementById('chat-box');
        box.innerHTML += `<div class="message assistant" style="background: rgba(56, 189, 248, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; align-self: flex-start; max-width: 80%;">ðŸš€ Generando escenario de optimizaciÃ³n automÃ¡tica...</div>`;
        box.scrollTop = box.scrollHeight;

        try {
            const response = await fetch('/api/ai_scenario', { method: 'POST' });
            const data = await response.json();
            box.innerHTML += `<div class="message assistant" style="background: rgba(56, 189, 248, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; align-self: flex-start; max-width: 80%; border-left: 4px solid var(--accent-blue);">${data.response}</div>`;
            box.scrollTop = box.scrollHeight;
        } catch (err) {
            console.error(err);
        }
    }
</script>
{% endblock %}